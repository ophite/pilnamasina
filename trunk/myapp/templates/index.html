{% extends "base.html" %}
{% block source %}
	<script src="/content/js/jquery.combobox.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" media="screen" href="/content/css/jquery.combobox.css" />
	<script src="/content/js/date.js" type="text/javascript"></script>
	<!-- script src="/content/js/jquery.multi-accordion-1.5.3.js" type="text/javascript"></script -->	
{% endblock %}		
		
{% load dict_by_key %}

{% block script %}

	<script type="text/javascript">

		function getfilters(key, filter_name){
			var values = new Array();
			
			$('[id^="' + filter_name + '"]').each(function(){
				values.push($(this).val());
			});

			return JSON.stringify(values)
		}
			
		function phonenumber_to_images(phonenumber){
			html = '';

			if (phonenumber.indexOf("+") != -1){
				html = '<img name="accordion_plus" src="" width="16" height="16" alt="">';
				phonenumber = phonenumber.replace('+', '');
			}
			
			for (var i = 0; i < phonenumber.length; i++) {
				html = html + '<img name="00' + phonenumber[i] + '" src="" width="16" height="16" alt="">';
			}
			
			return html;
		}
		
		function phonenumber_images_setpath(){
			$('img[name^="0"]').each(function(){ 
				name = $(this).attr('name');
				$(this).attr('src', location.protocol + '//' + location.host + '/content/img/phonenumber/' + name + '.png');
			});
			
			$('img[name^="accordion"]').each(function(){ 
				name = $(this).attr('name');
				$(this).attr('src', location.protocol + '//' + location.host + '/content/img/phonenumber/' + name + '.png');
			});
		}
		
		function tripsShow(json_trips){
			holder = $('#accordion');
			holder.html('');
			
			jQuery.each(json_trips, function(){	
				holder.append('<h3>'
								+ '<img name=' + (this.fields.type == 'Passenger' ? 'accordion_man_32' : 'accordion_auto_32') + ' src="" width="32" height="32" alt="">'
								//+ ' type:' + this.fields.type 
								//+ ' name:' + this.fields.name 
								+ this.fields.place_from 
								+ ' -> ' + this.fields.place_to 
								+ ' ' + new Date(this.fields.date).toString('dd.MM.yyyy HH:mm')
								+ '</a></h3>' 
								+ '<div><p>' + this.fields.comments + '</p> ' + phonenumber_to_images(this.fields.phone_number.toString()) + '</div>'
				);

				$("#accordion").accordion("destroy").accordion({
					collapsible: true,
					active:false
				});

				phonenumber_images_setpath();
			});	
		}
			
		function tripsGet(){
			$.ajax({
				url: "/search/",
				type: "GET",
				data: {
					'date_from': getfilters('date_from', 'datepicker_from'),
					'date_to':getfilters('date_to', 'datepicker_to'),
					'place_from':getfilters('place_from', 'combobox_from'),
					'place_to':getfilters('place_to', 'combobox_to'),
				},
				dataType: "json",
				success: function(msg){
					//alert('success');
				},
				complete: function(jsondata, stat) { 
					if (stat == "success"){
						json_all = json_parse(jsondata.responseText);
						json_trips = json_parse(json_all[0]);
						tripsShow(json_trips);
					}
				},
				error: function(msg){
					alert('error search');
				}
			});
		}

		$(function() {
		
			// INIT VARS
			search_controls_maxcount = 2;
			search_controls = 0;
			search_controls_indexes = new Array();
			
			// LOCALIZE
			{% autoescape off %}				
			$.timepicker.regional['ru'] = {
				timeOnlyTitle: '{{ time_translate|dict_getbykey:"timeOnlyTitle"}}',
				timeText: '{{ time_translate|dict_getbykey:"timeText"}}',
				hourText: '{{ time_translate|dict_getbykey:"hourText"}}',
				minuteText: '{{ time_translate|dict_getbykey:"minuteText"}}',
				secondText: '{{ time_translate|dict_getbykey:"secondText"}}',
				millisecText: '{{ time_translate|dict_getbykey:"millisecText"}}',
				timezoneText: '{{ time_translate|dict_getbykey:"timezoneText"}}',
				currentText: '{{ time_translate|dict_getbykey:"currentText"}}',
				closeText: '{{ time_translate|dict_getbykey:"closeText"}}',
				timeFormat: '{{ time_translate|dict_getbykey:"timeFormat"}}',
				amNames: str_to_list('{{ time_translate|dict_getbykey:"amNames"}}'),
				pmNames: str_to_list('{{ time_translate|dict_getbykey:"pmNames"}}'),
				isRTL: false
			};
			$.timepicker.setDefaults($.timepicker.regional['ru']);			
			$.datepicker.regional['ru'] = {
				closeText: '{{ date_translate|dict_getbykey:"closeText"}}',
				prevText: '{{ date_translate|dict_getbykey:"prevText"}}',
				nextText: '{{ date_translate|dict_getbykey:"nextText"}}',
				currentText: '{{ date_translate|dict_getbykey:"currentText"}}',
				monthNames:str_to_list('{{ date_translate|dict_getbykey:"monthNames"}}'),
				monthNamesShort: str_to_list('{{ date_translate|dict_getbykey:"monthNamesShort"}}'),
				dayNames: str_to_list('{{ date_translate|dict_getbykey:"dayNames"}}'),
				dayNamesShort: str_to_list('{{ date_translate|dict_getbykey:"dayNamesShort"}}'),
				dayNamesMin: str_to_list('{{ date_translate|dict_getbykey:"dayNamesMin"}}'),
				weekHeader: '{{ date_translate|dict_getbykey:"weekHeader"}}',
				dateFormat: '{{ date_translate|dict_getbykey:"dateFormat"}}',
				firstDay: 1,
				isRTL: false,
				showMonthAfterYear: false,
				yearSuffix: ''
			};
			$.datepicker.setDefaults($.datepicker.regional['ru']);
			
			// JQUERY INITIALIZE
			$( "input[type=submit], button" ).button();
			$("#combobox_from").combobox();
			$("#combobox_to").combobox();
			$('#datepicker_from').datetimepicker();
			$('#datepicker_to').datetimepicker();
			$( "#accordion" ).accordion({
				collapsible: true,
				active:false
			});

			//SET DEFAULTS/STYLE
			$('#datepicker_from').datetimepicker("setDate", new Date('{{date_from}}'));
			$('#datepicker_to').datetimepicker("setDate", new Date('{{date_to}}'));
			$('#combobox_from').val('{{place_from}}');
			$('#combobox_from').next().children('input').val($('#combobox_from').val());
			$('#combobox_to').val('{{place_to}}')
			$('#combobox_to').next().children('input').val($('#combobox_to').val());

			$( "[id=search]" ).attr('value','{{ controls_translate|dict_getbykey:"Go" }}');
			$( "[id=add_filter]" ).attr('value','{{ controls_translate|dict_getbykey:"Add" }}');
			$( "[id=add_new_trip]" ).attr('value','{{ controls_translate|dict_getbykey:"AddNewTrip" }}');
			$('b:contains("From:")').text('{{ controls_translate|dict_getbykey:"From:" }}');
			$('b:contains("To:")').text('{{ controls_translate|dict_getbykey:"To:" }}');
			$('h1:contains("Filters")').text('{{ controls_translate|dict_getbykey:"Filters" }}');
			{% endautoescape %}	
			
			//SET DEFAULTS/STYLE
			$('#datepicker_from').addClass('ui-combobox-input ui-state-default ui-widget ui-widget-content ui-corner-left ui-corner-right');
			$('#datepicker_to').addClass('ui-combobox-input ui-state-default ui-widget ui-widget-content ui-corner-left ui-corner-right');
			
			// AJAX, EVENT
			{% autoescape off %}
			$("[id=search]").click(function( event ) {
				tripsGet();
			});
			
			$("[id=add_filter]").click(function( event ) {
				isNew = false;
				
				do{
					search_controls++;
					
					if (search_controls_indexes.indexOf(search_controls) == -1){
						isNew=true;
						search_controls_indexes.push(search_controls);
						break;
					}
				}
				while(search_controls<=search_controls_maxcount)

				if(search_controls_indexes.length > search_controls_maxcount){
					//$('#Add').hide();
					$('#add_filter').attr('disabled', true);
				}
				
				if (isNew==false)
					return;
				
				html_option = '';
				$.map($('#combobox_from option'), function(e) { return html_option += '<option value="' + e.value + '">' + e.value + '</option>'; });
				
				$('<tr id="filter_' + search_controls + '">'
					+'<td>' 
						+'<input id="Del_' + search_controls + '" type="submit" value="{{ controls_translate|dict_getbykey:"Delete" }}" />'
					+'</td>'
					+'<td><b>{{ controls_translate|dict_getbykey:"From:"}}</b><input class="search_datepicker" type="text" id="datepicker_from_' + search_controls + '" />'
						+' <select id="combobox_from_' + search_controls + '">'
						+ html_option
						+'</select>'
					+'</td>'
					+'<td><b>{{ controls_translate|dict_getbykey:"To:"}}</b><input class="search_datepicker" type="text" id="datepicker_to_' + search_controls + '" />'
						+' <select id="combobox_to_' + search_controls + '">'
						+ html_option
						+'</select>'	
					+'</td>'
				+'</tr>').appendTo('#filter_main');
				//.insertAfter('#filter_first')
			
				// reInit
				var date_from = '{{date_from}}' != ''? new Date('{{date_from}}') : new Date();
				$('[id^="datepicker_from_' + search_controls + '"]').datetimepicker('destroy').datetimepicker();
				$('[id^="datepicker_from_' + search_controls + '"]').datetimepicker("setDate", date_from);

				var date_to = '{{date_to}}' != ''? new Date('{{date_to}}') : new Date();
				$('[id^="datepicker_to_' + search_controls + '"]').datetimepicker('destroy').datetimepicker();
				$('[id^="datepicker_to_' + search_controls + '"]').datetimepicker("setDate", date_to);
			
				$('[id^="combobox_from_' + search_controls + '"]').combobox();
				//$('[id^="combobox_from_' + search_controls + '"]').next().children('input').val('');			

				$('[id^="combobox_to_' + search_controls + '"]').combobox();
				//$('[id^="combobox_to_' + search_controls + '"]').next().children('input').val('');

				$('[id^="accordion"]').accordion("destroy").accordion({
																collapsible:true,
																active:false
															});
		
				$('[id^="datepicker_from_' + search_controls + '"]').addClass('ui-combobox-input ui-state-default ui-widget ui-widget-content ui-corner-left ui-corner-right');
				$('[id^="datepicker_to_' + search_controls + '"]').addClass('ui-combobox-input ui-state-default ui-widget ui-widget-content ui-corner-left ui-corner-right');

				// delete current filter
				$('[id^="Del_' + search_controls + '"]')
					.button()
					.click(function( event ) {
							
						str = $(this).attr('id');
						search_control = str.substring(str.length, str.length-1);
						search_controls_indexes.splice(search_controls_indexes.indexOf(parseInt(search_control)), 1);

						search_controls = 0;
						//$('#add_filter').show();
						$('#add_filter').attr('disabled', false)
						
						$(this).parent().parent().remove();;
						//event.preventDefault();
				});
			});
			
			$("[id=add_new_trip]").click(function( event ) {							
				$.ajax({
					url: '/set_session/',
					data: {
						'date_from': $('#datepicker_from').val(), 
						'date_to': $('#datepicker_to').val(),
						'place_from': $('#combobox_from').val(),
						'place_to':	$('#combobox_to').val()
					},	
					success: function(msg){
						//alert('success');
					},
					complete:function(jsondata, stat){
						if (stat == "success"){
							document.location.href = location.protocol + '//' + location.host + '/add';
						}
					},
					//dataType: "json",
					type: 'GET',
					error : function () {
						alert('error add_new_trip');
						console.log("add_new_trip ajax error");
					}
				});				
			});

			tripsGet();
			{% endautoescape %}	
		});
	</script>

{% endblock %}
	
{% block content %}

	<table>
		<tr>
			<td>
				<h1>Filters</h1>
			</td>
			<td id="right">
				<input id="add_new_trip" type="submit" value="Add new trip" />
				<!-- <h1><a href='/add/' id="add_new_trip"> Add new trip </a></h1> -->
			</td>
		</tr>
		<table id="filter_main">
			<tr id="filter_first">
					<td>
						<input id="search" type="submit" value="Go" />
						<input id="add_filter" type="submit" value="Add" />
					</td>
					<td><b>From:</b><input type="text" id="datepicker_from" />
						<select id="combobox_from" >
						{% for k,v in cities.items %}
							<option value={{v}}>{{v}}</option>
						{% endfor %}
						</select>
					</td>
					<td><b>To:</b><input type="text" id="datepicker_to" />
						<select id="combobox_to">
						{% for k,v in cities.items  %}
							<option value={{v}}>{{v}}</option>
						{% endfor %}
						</select>
					</td>
				</div>
			</tr>
		</table>
	</table>
	<div id="accordion"></div>
{% endblock %}							