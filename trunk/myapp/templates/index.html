{% extends "base.html" %}
{% block source %}
	<script src="/content/js/jquery.combobox.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" media="screen" href="/content/css/jquery.combobox.css" />
	<script src="/content/js/date.js" type="text/javascript"></script>
{% endblock %}		
		
{% load dict_by_key %}
{% load order_list %}

{% block script %}

	<script type="text/javascript">
	
		// IE not support stringify
		jQuery.extend({
			stringify  : function stringify(obj) {
				var t = typeof (obj);
				if (t != "object" || obj === null) {
					// simple data type
					if (t == "string") obj = '"' + obj + '"';
					return String(obj);
				} else {
					// recurse array or object
					var n, v, json = [], arr = (obj && obj.constructor == Array);

					for (n in obj) {
						v = obj[n];
						t = typeof(v);
						
						if (obj.hasOwnProperty(n)) {
							if (t == "string") 
								v = '"' + v + '"'; 
							else if (t == "object" && v !== null) 
								v = jQuery.stringify(v);
								
							json.push((arr ? "" : '"' + n + '":') + String(v));
						}
					}
					return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
				}
			}
		});
	
		function phonenumber_to_images(phonenumber){
			html = '';
			if (phonenumber.indexOf("+") != -1){
				html = '<img name="accordion_plus" src="" width="7" height="12" alt="">';
				phonenumber = phonenumber.replace('+', '');
			}
				
			
			for (var i = 0; i < phonenumber.length; i++) {
				html = html + '<img name="00' + phonenumber.charAt(i) + '" src="" width="7" height="12" alt="">';
			}
			
			return html;
		}
		
		function phonenumber_images_setpath(){
			$('img[name^="0"]').each(function(){ 
				name = $(this).attr('name');
				$(this).attr('src', location.protocol + '//' + location.host + '/content/img/phonenumber/' + name + '.png');
			});
			
			$('img[name^="accordion"]').each(function(){ 
				name = $(this).attr('name');
				$(this).attr('src', location.protocol + '//' + location.host + '/content/img/phonenumber/' + name + '.png');
			});
		}
		
		function showTrips(json_trips){
			holder = $('#accordion');
			holder.html('');
			
	 
			jQuery.each(json_trips, function(){	

				holder.append('<h3><a href="#">'
								+ '<img name=' + (this.fields.type == 'Passenger' ? 'accordion_man_32' : 'accordion_auto_32') + ' src="" width="20" height="20" alt="">'														
								+ ' ' +  (($.browser.msie) ? new Date(this.fields.date.replace('-','/').replace('T', ' ')).toString('yyyy.MM.dd HH:mm') : new Date(this.fields.date).toString('yyyy.MM.dd | HH:mm'))
								+ ' | ' + this.fields.place_from 
								+ ' > ' + this.fields.place_to 
								+ ' | ' + phonenumber_to_images(this.fields.phone_number.toString())
								+ ' | ' + this.fields.name
								+ '</a></h3>' 
								+ '<div><p>' + this.fields.comments + '</p></div>'
				);
				
				phonenumber_images_setpath();
			});	
		}
			
		function getTrips(filterValues){
			$.ajax({
				url: "/search/",
				type: "GET",
				data: filterValues,
				dataType: "json",
				success: function(msg){
					//alert('success');
				},
				complete: function(jsondata, stat) { 
					if (stat == "success"){
						json_all = json_parse(jsondata.responseText);
						
						// trips
						json_trips = json_parse(json_all[0]);
						showTrips(json_trips);
						tooglePanels();
						
						// filters
						// build filters only if filterValues not exists(it F5 - refresh page)
						// if exists - it means we only search trips
						if (filterValues == null){
							// filters
							filters = json_parse(json_all[1]);
							filterLength = 0;					
							
							for(filter in filters){
								filterLength = json_parse(filters[filter]).length;
							}
							
							// create params for filter
							params = {};
							
							// first static filter					
							for(filter in filters){
								params[filter] = json_parse(filters[filter])[0];
							}
							
							setFilterStyle(first_filter_prefix);							
							setFilterValue(params, first_filter_prefix);
							params = {};
							
							// other dynamic filters 
							for(var i = 1; i < filterLength; i++){
								for(filter in filters){
									params[filter] = json_parse(filters[filter])[i];
								}
								
								addFilter(params);
								params = {};
							}
						}
					}
				},
				error: function(msg){
					alert('error search');
				}
			});
		}
		
		function addTrip(){
			rememberFilters(true, true);	
		}
	
		function tooglePanels(){
			$("#accordion")
			.addClass("ui-accordion ui-accordion-icons ui-widget ui-helper-reset")
			.find("h3")
			.addClass("ui-accordion-header ui-helper-reset ui-state-default ui-corner-top ui-corner-bottom")
			.hover(function() { $(this).toggleClass("ui-state-hover"); })
			//.prepend('<span class="ui-icon ui-icon-triangle-1-e"></span>') //treugolnik
			.click(function() {
				$(this)
				.toggleClass("ui-accordion-header-active ui-state-active ui-state-default ui-corner-bottom")
				.find("> .ui-icon").toggleClass("ui-icon-triangle-1-e ui-icon-triangle-1-s")
				.end()
				.next().toggleClass("ui-accordion-content-active").slideToggle();
				
				return false;
			})
			.next()
			.addClass("ui-accordion-content  ui-helper-reset ui-widget-content ui-corner-bottom")
			.hide();
		}
		
		function setFilterStyle(search_controls){
			$('[id^="datepicker_from' + search_controls + '"]').addClass('ui-combobox-input ui-state-default ui-widget ui-widget-content ui-corner-left ui-corner-right');
			$('[id^="datepicker_to' + search_controls + '"]').addClass('ui-combobox-input ui-state-default ui-widget ui-widget-content ui-corner-left ui-corner-right');
			$('[id^="search"]').width(parseInt($('[id="add_new_trip"]').width()));
	
			$('[id^="combobox_from' + search_controls + '"]').combobox();			
			$('[id^="combobox_to' + search_controls + '"]').combobox();
			
			$('[id^="datepicker_from' + search_controls + '"]').width(datetimepicker_width);
			$('[id^="datepicker_to' + search_controls + '"]').width(datetimepicker_width);
				
			$('[title^="Show All Items"]').attr('title', '{{ controls_translate|dict_getbykey:"ShowAllItems" }}');
		}
		
		function setFilterValue(filterValues, search_controls){
			// date
			dateFrom = filterValues['date_from'];
			var date_from = dateFrom != ''? new Date(dateFrom) : new Date();
			$('[id^="datepicker_from' + search_controls + '"]').datetimepicker('destroy').datetimepicker();
			$('[id^="datepicker_from' + search_controls + '"]').datetimepicker("setDate", date_from);

			dateTo = filterValues['date_to'];
			var date_to = dateTo != ''? new Date(dateTo) : new Date();
			$('[id^="datepicker_to' + search_controls + '"]').datetimepicker('destroy').datetimepicker();
			$('[id^="datepicker_to' + search_controls + '"]').datetimepicker("setDate", date_to);
			// place
			placeFrom = filterValues['place_from'];
			if (placeFrom != null){
				$('[id^="combobox_from' + search_controls + '"]').val(placeFrom);
				$('[id^="combobox_from' + search_controls + '"]').next().children('input').val(placeFrom);
			}
			
			placeTo = filterValues['place_to'];
			if (placeTo != null){
				$('[id^="combobox_to' + search_controls + '"]').val(placeTo);
				$('[id^="combobox_to' + search_controls + '"]').next().children('input').val(placeTo);
			}

			// for first only
			if (search_controls == first_filter_prefix) {
				type = filterValues['type'];
				$('[id^="type"]').val(type);
				$('[id^="type"]').next().children('input').val(type);
			}
		}
		
		function addFilter(filterValues){
			isNew = false;
			
			do{
				search_controls++;
				
				if (search_controls_indexes.indexOf(search_controls) == -1){
					isNew=true;
					search_controls_indexes.push(search_controls);
					break;
				}
			}
			while(search_controls<=search_controls_maxcount)

			if(search_controls_indexes.length > search_controls_maxcount){
				$('#add_filter').attr('disabled', true);
			}
			
			if (isNew==false)
				return;
			
			html_option = '';
			$.map($('#combobox_from_first option'), function(e) { return html_option += '<option value="' + e.value + '">' + e.value + '</option>'; });
			
			$('<tr id="filter_' + search_controls + '">'
				+'<div id = "div_filter_' + search_controls + '">'
				+'<td style="text-align:right"><b>{{ controls_translate|dict_getbykey:"From:"}}</b></td>'
				+'<td style="text-align:left;"><input class="search_datepicker" type="text" id="datepicker_from' + search_controls + '" />'
					+' <select id="combobox_from' + search_controls + '">'
					+ html_option
					+'</select>'
				+'</td>'
				+'<td style="text-align:left;" width="333"><b>{{ controls_translate|dict_getbykey:"To:"}}</b><input class="search_datepicker" type="text" id="datepicker_to' + search_controls + '" />'
					+' <select id="combobox_to' + search_controls + '">'
					+ html_option
					+'</select>'	
				+'</td>'
				+'<td valign="middle" width="17" style="text-align:left;">' 
					+'<input src="content/img/Icons/Web_2.0/Zoom_Out.png" id="Del_' + search_controls + '" type="image" value="{{ controls_translate|dict_getbykey:"Delete" }}" width="17" height="17"/>'
				+'</td>' //knopka minus
				+'</div>'
			+'</tr>').appendTo('#filter_main');
	    
			// reInit
			setFilterValue(filterValues, search_controls);
			setFilterStyle(search_controls);
			
			// delete current filter
			$('[id^="Del_' + search_controls + '"]')
				.button()
				.click(function( event ) {
						
					str = $(this).attr('id');
					search_control = str.substring(str.length, str.length-1);
					search_controls_indexes.splice(search_controls_indexes.indexOf(parseInt(search_control)), 1);

					search_controls = 0;
					$('#add_filter').attr('disabled', false)
					
					$(this).parent().parent().remove();
			});
			
            $('[id^="Del_' + search_controls + '"]').width(parseInt($('[id="add_filter"]').width())+1);			
		}

		function getFilter(key, filter_name){
			var values = new Array();
			
			$('[id^="' + filter_name + '"]').each(function(){
				values.push($(this).val());
			});

			var res = jQuery.stringify(values);
			
			return res;
		}
		
		function getFilters(){
			return {
					'date_from':getFilter('date_from', 'datepicker_from'),
					'date_to':getFilter('date_to', 'datepicker_to'),
					'place_from':getFilter('place_from', 'combobox_from'),
					'place_to':getFilter('place_to', 'combobox_to'),
					'type':jQuery.stringify([$('#type').val(),])
			}
		}
		
		/*
			redirectToAddTrip - for redirect ot add.html page
			asyncValue - async mode for refresh current page to save filter values
		*/
		function rememberFilters(redirectToAddTrip, asyncValue){
			$.ajax({
				url: '/set_session/',
				data: getFilters(),	
				success: function(msg){
					//alert('success');
				},
				complete:function(jsondata, stat){
					if (stat == "success" & redirectToAddTrip == true){
						document.location.href = location.protocol + '//' + location.host + '/add';
					}
				},
				//dataType: "json",
				type: 'GET',
				async : asyncValue,
				error : function () {
					alert('error rememberFilters');
					console.log("rememberFilters ajax error");
				}
			});				
		}
		
		function saveFilters(){
			$(window).unload(function() {
				rememberFilters(false, false);				
			});
		}
		
		$(function() {
			json_stringify_IE();
			
			// INIT VARS
			search_controls_maxcount = 1;
			search_controls = 0;
			search_controls_indexes = new Array();
			datetimepicker_width = 121; // set custom datetime width 
			first_filter_prefix = '_first';
			
			// LOCALIZE
			{% autoescape off %}				
			$.timepicker.regional['ru'] = {
				timeOnlyTitle: '{{ time_translate|dict_getbykey:"timeOnlyTitle"}}',
				timeText: '{{ time_translate|dict_getbykey:"timeText"}}',
				hourText: '{{ time_translate|dict_getbykey:"hourText"}}',
				minuteText: '{{ time_translate|dict_getbykey:"minuteText"}}',
				secondText: '{{ time_translate|dict_getbykey:"secondText"}}',
				millisecText: '{{ time_translate|dict_getbykey:"millisecText"}}',
				timezoneText: '{{ time_translate|dict_getbykey:"timezoneText"}}',
				currentText: '{{ time_translate|dict_getbykey:"currentText"}}',
				closeText: '{{ time_translate|dict_getbykey:"closeText"}}',
				timeFormat: '{{ time_translate|dict_getbykey:"timeFormat"}}',
				amNames: str_to_list('{{ time_translate|dict_getbykey:"amNames"}}'),
				pmNames: str_to_list('{{ time_translate|dict_getbykey:"pmNames"}}'),
				isRTL: false
			};
			$.timepicker.setDefaults($.timepicker.regional['ru']);			
			$.datepicker.regional['ru'] = {
				closeText: '{{ date_translate|dict_getbykey:"closeText"}}',
				prevText: '{{ date_translate|dict_getbykey:"prevText"}}',
				nextText: '{{ date_translate|dict_getbykey:"nextText"}}',
				currentText: '{{ date_translate|dict_getbykey:"currentText"}}',
				monthNames:str_to_list('{{ date_translate|dict_getbykey:"monthNames"}}'),
				monthNamesShort: str_to_list('{{ date_translate|dict_getbykey:"monthNamesShort"}}'),
				dayNames: str_to_list('{{ date_translate|dict_getbykey:"dayNames"}}'),
				dayNamesShort: str_to_list('{{ date_translate|dict_getbykey:"dayNamesShort"}}'),
				dayNamesMin: str_to_list('{{ date_translate|dict_getbykey:"dayNamesMin"}}'),
				weekHeader: '{{ date_translate|dict_getbykey:"weekHeader"}}',
				dateFormat: '{{ date_translate|dict_getbykey:"dateFormat"}}',
				firstDay: 1,
				isRTL: false,
				showMonthAfterYear: false,
				yearSuffix: ''
			};
			$.datepicker.setDefaults($.datepicker.regional['ru']);

			// JQUERY INITIALIZE
			$("input[type=submit], button").button();
			$('#type').combobox();
			$('#type').next().children('input').width(datetimepicker_width-$('#type').next().children('a').width());

			// for quick draw jquery style
			setFilterStyle(first_filter_prefix);

			// LOCALIZE
			$("[id=search]").attr('value','{{ controls_translate|dict_getbykey:"Go" }}');
			$("[id=add_filter]").attr('value','{{ controls_translate|dict_getbykey:"Add" }}');
			$("[id=add_new_trip]").attr('value','{{ controls_translate|dict_getbykey:"AddNewTrip" }}');
			$('b:contains("From:")').text('{{ controls_translate|dict_getbykey:"From:" }}');
			$('b:contains("To:")').text('{{ controls_translate|dict_getbykey:"To:" }}');
			$('h1:contains("Filters")').text('{{ controls_translate|dict_getbykey:"Filters" }}');
			{% endautoescape %}	
			
			// AJAX, EVENT
			$("[id=search]").click(function( event ) {
				filterValues = getFilters();
				getTrips(filterValues);
			});
			
			$("[id=add_filter]").click(function( event ) {
				filterValues = { 
					'date_from' : '{{ date_from }}',
					'date_to': '{{ date_to }}', 
					'place_from': null,
					'place_to' : null
				}

				addFilter(filterValues);
			});
			
			$("[id=add_new_trip]").click(function( event ) {	
				addTrip();
			});
			
			getTrips();
			saveFilters();
		});
	</script>

{% endblock %}
	
{% block content %}

	<table id="filter_main" align="center" border="0">
		<tr>
		    <td style="text-align:right">
				<b>Kas:</b>
			</td>
			<td>
				<select id="type">
					{% for k,v in types.items|sort %}
						<option value={{k}}>{{v}}</option>
					{% endfor %}
				</select>
			</td>
			
			    <td colspan="3" id="right">
			
			        <input src="content/img/Icons/Web_2.0/Write.png" id="add_new_trip" type="image" value="Add new trip" />
			        <!-- <img src="content/img/Icons/Web_2.0/Write.png" id="add_new_trip" type="submit" value="Add new trip" /> -->
				   <!-- <input id="add_new_trip" type="submit" value="Add new trip" /> // KNOPKA "SUKURTI -->
				   <!-- <h1><a href='/add/' id="add_new_trip"> Add new trip </a></h1> -->
				   
			</td>
				</tr>
		        <tr>
			    <td style="text-align:right">
				<b>From:</b>
				</td>
				<td><input type="text" id="datepicker_from_first" />
					<select id="combobox_from_first">
					{% for k,v in cities.items|sort %}
						<option value={{k}}>{{v}}</option>
					{% endfor %}
					</select>
				</td>
				<td style="text-align:left;" width="333"><b>To:</b><input type="text" id="datepicker_to_first" />
					<select id="combobox_to_first">
					{% for k,v in cities.items|sort  %}
						<option value={{k}}>{{v}}</option>
					{% endfor %}
					</select>
				</td>
				<td valign="middle" width="17" style="text-align:left;">
				<input src="content/img/Icons/Web_2.0/Zoom_In.png" id="add_filter" type="image" value="Add" width="17" height="17"/> 
				<!-- <img src="content/img/Icons/Web_2.0/Zoom_In.png" id="add_filter" type="submit" value="Add" width="17" height="17"/>  -->
				<!-- <input id="add_filter" type="submit" value="Add"/> -->	
				</td>
				<td style="text-align:right;" width="32">
				    <input src="content/img/Icons/Web_2.0/Search.png" id="search" type="image" value="Go" />
			        <!-- <input  id="search" type="submit" value="Go"/> // KNOPKA "IESKOTI"-->					
				</td>
		</tr>
	</table>
	<div id="accordion"></div>	

{% endblock %}							